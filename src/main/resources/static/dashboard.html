<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth67 - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 flex flex-col h-screen">

    <div id="app" class="flex flex-col h-full" v-cloak>
        <!-- Navbar -->
        <nav class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex">
                        <div class="flex-shrink-0 flex items-center">
                            <h1 class="text-xl font-bold text-blue-600">Auth67 Admin</h1>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="text-gray-700 mr-4">Hello, {{ currentUser }}</span>
                        <button @click="logout" class="text-gray-500 hover:text-red-600">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-8">
            <div class="max-w-7xl mx-auto">
                
                <!-- Header & Actions -->
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">User Management</h2>
                    <button @click="openCreateModal" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow transition">
                        <i class="fas fa-plus mr-2"></i> New User
                    </button>
                </div>

                <!-- Error Message -->
                <div v-if="errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                    <strong class="font-bold">Error:</strong>
                    <span class="block sm:inline">{{ errorMessage }}</span>
                    <span class="absolute top-0 bottom-0 right-0 px-4 py-3" @click="errorMessage = ''">
                        <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
                    </span>
                </div>

                <!-- Users Table -->
                <div class="bg-white shadow rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Roles</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr v-for="user in users" :key="user.id">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">#{{ user.id }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ user.username }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <span v-for="role in user.roles" :key="role" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mr-1">
                                        {{ role }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span v-if="user.locked" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Locked</span>
                                    <span v-else class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button @click="openEditModal(user)" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                                    <button @click="deleteUser(user)" class="text-red-600 hover:text-red-900">Delete</button>
                                </td>
                            </tr>
                            <tr v-if="users.length === 0">
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">No users found.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Modal -->
        <div v-if="showModal" class="fixed z-10 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" @click="closeModal"></div>
                <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                    {{ isEditing ? 'Edit User' : 'Create New User' }}
                                </h3>
                                <div class="mt-4 space-y-4">
                                    <div v-if="!isEditing">
                                        <label class="block text-gray-700 text-sm font-bold mb-2">Username</label>
                                        <input v-model="form.username" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    </div>
                                    <div v-if="!isEditing">
                                        <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                                        <input v-model="form.password" type="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 text-sm font-bold mb-2">Roles (comma separated)</label>
                                        <input v-model="form.rolesInput" type="text" placeholder="ROLE_USER, ROLE_ADMIN" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                        <p class="text-xs text-gray-500 mt-1">New roles will be created automatically.</p>
                                    </div>
                                    <div class="flex items-center">
                                        <input v-model="form.locked" id="locked" type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        <label for="locked" class="ml-2 block text-sm text-gray-900">Account Locked</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button @click="saveUser" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                            Save
                        </button>
                        <button @click="closeModal" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue

        // --- Axios Setup with Interceptor ---
        const api = axios.create({
            baseURL: '/api'
        });

        api.interceptors.request.use(config => {
            const token = localStorage.getItem('access_token');
            if (token) {
                config.headers['Authorization'] = 'Bearer ' + token;
            }
            return config;
        });

        let isRefreshing = false;
        let failedQueue = [];

        const processQueue = (error, token = null) => {
            failedQueue.forEach(prom => {
                if (error) prom.reject(error);
                else prom.resolve(token);
            });
            failedQueue = [];
        };

        api.interceptors.response.use(
            response => response,
            async error => {
                const originalRequest = error.config;

                if (error.response.status === 403 && !originalRequest._retry) { // 403 Forbidden is used for both expired and denied in our config
                    
                    if (isRefreshing) {
                        return new Promise((resolve, reject) => {
                            failedQueue.push({ resolve, reject });
                        }).then(token => {
                            originalRequest.headers['Authorization'] = 'Bearer ' + token;
                            return api(originalRequest);
                        }).catch(err => Promise.reject(err));
                    }

                    originalRequest._retry = true;
                    isRefreshing = true;

                    try {
                        const refreshToken = localStorage.getItem('refresh_token');
                        if(!refreshToken) throw new Error("No refresh token");

                        const rs = await axios.post('/api/auth/refresh-token', {
                            refresh_token: refreshToken
                        }, { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('access_token') } }); 

                        const { access_token, refresh_token } = rs.data;

                        localStorage.setItem('access_token', access_token);
                        // Update refresh token if rotated
                        if(refresh_token) localStorage.setItem('refresh_token', refresh_token);

                        api.defaults.headers.common['Authorization'] = 'Bearer ' + access_token;
                        originalRequest.headers['Authorization'] = 'Bearer ' + access_token;

                        processQueue(null, access_token);
                        isRefreshing = false;

                        return api(originalRequest);
                    } catch (_error) {
                        processQueue(_error, null);
                        isRefreshing = false;
                        // Logout logic
                        localStorage.clear();
                        window.location.href = '/index.html';
                        return Promise.reject(_error);
                    }
                }
                return Promise.reject(error);
            }
        );

        // --- Vue App ---
        createApp({
            data() {
                return {
                    currentUser: localStorage.getItem('username') || 'Admin',
                    users: [],
                    showModal: false,
                    isEditing: false,
                    errorMessage: '',
                    form: {
                        id: null,
                        username: '',
                        password: '',
                        rolesInput: '',
                        locked: false
                    }
                }
            },
            mounted() {
                if (!localStorage.getItem('access_token')) {
                    window.location.href = '/index.html';
                } else {
                    this.fetchUsers();
                }
            },
            methods: {
                async fetchUsers() {
                    try {
                        const res = await api.get('/users');
                        this.users = res.data;
                    } catch (err) {
                        this.handleError(err);
                    }
                },
                openCreateModal() {
                    this.isEditing = false;
                    this.form = {
                        id: null,
                        username: '',
                        password: '',
                        rolesInput: 'ROLE_USER',
                        locked: false
                    };
                    this.showModal = true;
                },
                openEditModal(user) {
                    this.isEditing = true;
                    this.form = {
                        id: user.id,
                        username: user.username,
                        password: '', // Can't edit password here simply
                        rolesInput: user.roles.join(', '),
                        locked: user.locked
                    };
                    this.showModal = true;
                },
                closeModal() {
                    this.showModal = false;
                    this.errorMessage = '';
                },
                async saveUser() {
                    const rolesArray = this.form.rolesInput.split(',').map(r => r.trim()).filter(r => r.length > 0);
                    
                    try {
                        if (this.isEditing) {
                            // Update
                            await api.put(`/users/${this.form.id}`, {
                                roles: rolesArray,
                                locked: this.form.locked
                            });
                        } else {
                            // Create
                            await api.post('/auth/register', {
                                username: this.form.username,
                                password: this.form.password,
                                roles: rolesArray
                            });
                        }
                        this.closeModal();
                        this.fetchUsers();
                    } catch (err) {
                        this.handleError(err);
                    }
                },
                async deleteUser(user) {
                    if (!confirm(`Are you sure you want to delete ${user.username}?`)) return;
                    try {
                        await api.delete(`/users/${user.id}`);
                        this.fetchUsers();
                    } catch (err) {
                        this.handleError(err);
                    }
                },
                logout() {
                    localStorage.clear();
                    window.location.href = '/index.html';
                },
                handleError(err) {
                    console.error(err);
                    if (err.response && err.response.data) {
                        this.errorMessage = err.response.data.message || err.response.data.error || 'An error occurred';
                    } else {
                        this.errorMessage = 'Network error or server unavailable.';
                    }
                }
            }
        }).mount('#app')
    </script>
    <style>
        [v-cloak] { display: none; }
    </style>
</body>
</html>
